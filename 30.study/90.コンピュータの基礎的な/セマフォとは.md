# セマフォ  【 semaphore 】 

- コンピュータ上の共有資源について、利用可能な資源の数
- コンピュータで並列処理を行う際、同時に実行されているプログラム間でリソースの排他制御や同期を行う仕組みの一つ。

## 動き
- プログラムが資源を占有するときはセマフォの値から1を減じ、処理が終わって解放する際には1を加える。
- セマフォが0のときは空いている資源がないため正の値になるまで待機する。
- セマフォの値を同じ資源に同時にアクセスできるプロセスの数として扱う場合もある。

## P 操作 と V 操作
- 資源を獲得しセマフォを減じる処理を「P操作」（関数名などにはdown/wait/acquire/pendなどが好まれる）
- 資源を解放しセマフォを加える処理を「V操作」（同up/signal/release/postなど）という。

# セマフォによる同期
- セマフォの値の増減はどのプログラムからも常に可能であるため、同期処理に用いることもできる。

- 例) 一方のプロセスが共有資源に書き込んだデータをもう一方が読み込む処理について
- 書き込み側がセマフォを減じておくことで、書き込み処理が完了するまで読み込み側を待たせておくといった処理が可能

## セマフォとミューテックス
- 資源が複数ある場合を計数セマフォ（カウンティングセマフォ）と呼び、
- 資源が一つの場合（値が0と1に限られる）を2進セマフォ（バイナリセマフォ）という
- バイナリセマフォは当該資源が利用可能か不可能かを表すとも考えられ、競合を防止するミューテックス（mutex）とほぼ同じ機能となる

# 共有ロックと排他ロック
- 共有ロック → 他プロセスがREAD(読み込み)するのは許すがUPDATE(更新)するのは許さないロック。
- 排他ロック → 他プロセスがREADするのもUPDATEするのも許さないロック。
- これらロックの制御を実装しているのがRDBMS(MySQLやPostgreSQL)のミドルウェアやOSです。
- RDBMSはDBのテーブル、レコードをロックし、OSはファイルなどをロックします(ファイルロック)。

# 楽観的ロックと悲観的ロック
楽観的ロックと悲観的ロックというのは、アプリケーション実装者の立場による区別です。
具体的にはアプリケーションの複数ユーザーがあるデータを同時に更新するという状況に対するアプローチの区別です。
少なくともDBやRDBMSがメインで提供する機能ではありません(※)。

※ RDBMSによっては楽観的ロック、悲観的ロックの機能を提供するものもあるようです。IBMのsolidDBなど。

## 楽観的ロック
- 楽観的ロックではデータ読み出し時に内容をキャッシュしておき、
- データを更新する直前に、他のユーザーによって更新されていないかどうかをチェックします。
- そして他のユーザーによってすでに更新されていた場合、更新処理をキャンセルします。

- この制御を実装するのは、アプリケーション実装者です。

- 近年では、各言語のORマッパーがこの制御の実装をサポートしています。
(JavaのDoma、C#のLinq to SQL、Ruby on RailsのActiveRecordなどで楽観的ロック時の例外が用意されています。)

## 悲観的ロック
- 悲観的排他制御では、更新対象のデータ読み出しの時点で、他のユーザーがそのデータに触れないようロックをします。

- このとき、ロックのモード(共有ロック、排他ロック)の選択はアプリケーション実装者に委ねられます。